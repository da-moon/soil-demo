pod "http-echo" {
  runtime = true
  target = "default.target"
  provider "range" "port" {
    min = 5000
    max = 9000
  }
  resource "http-echo.port" "5678" {}
  unit "http-echo-rs.service" {
    permanent = false
    create = "start"
    update = "restart"
    destroy = "stop"
    source = <<EOF
      [Unit]
      Description=%p

      [Service]
      SyslogIdentifier=%p
      Restart=on-failure
      RestartSec=30

      ExecStartPre=-/usr/bin/docker pull fjolsvin/http-echo-rs:latest
      ExecStart=/usr/bin/docker run --rm --name=%p \
          fjolsvin/http-echo-rs:latest  \
              --listen=":${resource.http-echo.8080.value}" \
              --text="Soil Deployment Example"
      ExecReload=/usr/bin/docker kill -s HUP %p
      [Install]
      WantedBy=multi-user.target
    EOF
  }
}
